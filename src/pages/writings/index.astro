---
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { getCollection } from "astro:content";
import {
  calculateReadingTime,
  formatReadingTime,
} from "../../utils/readingTime";

// Get all writings and memos
const writings = await getCollection("writings");
const memos = await getCollection("memos");

// Filter published posts and combine
const publishedWritings = writings.filter(
  ({ data }) => data.published !== false,
);
const publishedMemos = memos.filter(({ data }) => data.published !== false);

// Combine and sort by date
const allPosts = [...publishedWritings, ...publishedMemos].sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

// Group posts by year
const postsByYear = new Map<number, typeof allPosts>();
for (const post of allPosts) {
  const year = post.data.date.getFullYear();
  if (!postsByYear.has(year)) {
    postsByYear.set(year, []);
  }
  postsByYear.get(year)!.push(post);
}

// Helper function to format date
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
}

function bannerUrl(postId: string, banner: string) {
  if (banner.startsWith("http")) return banner;
  return `https://ik.imagekit.io/aravindballa/website/${postId}-${banner}`;
}

// State for filtering will be handled client-side
---

<Layout title="Writings">
  <Breadcrumb crumbs={[{ label: "Aravind Balla", href: "/" }]} />
  <div class="space-y-12">
    <div>
      <h1 class="text-4xl font-bold font-poppins mb-6">Writings</h1>
      <p class="text-lg text-[var(--muted)]">
        Thoughts on web development, productivity, and building products.
      </p>
    </div>

    <!-- Filter Buttons -->
    <div class="flex gap-2" id="filter-buttons">
      <button
        data-filter="all"
        class="filter-btn px-4 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--surface)] transition-colors active"
      >
        All
      </button>
      <button
        data-filter="writings"
        class="filter-btn px-4 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--surface)] transition-colors"
      >
        Blog posts
      </button>
      <button
        data-filter="memos"
        class="filter-btn px-4 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--surface)] transition-colors"
      >
        Memos
      </button>
    </div>

    <!-- Posts grouped by year -->
    <div id="posts-grid">
      {
        [...postsByYear.entries()].map(([year, posts]) => (
          <section class="year-section mb-12" data-year={year}>
            <h2 class="text-2xl font-bold font-poppins mb-6 text-[var(--headings)]">
              {year}
            </h2>
            <div class="columns-1 md:columns-2 gap-6">
              {posts.map((post) => {
                const isMemo = post.collection === "memos";
                const postUrl = isMemo
                  ? `/memos/${post.id}`
                  : `/writings/${post.id}`;
                const readingTime = calculateReadingTime(post.body || "");

                return (
                  <article
                    class="post-card group break-inside-avoid mb-6 overflow-hidden rounded-lg border border-[var(--border)] hover:shadow-lg transition-all duration-300"
                    data-type={isMemo ? "memos" : "writings"}
                  >
                    {post.data.banner && post.data.banner.trim() && (
                      <div class="overflow-hidden">
                        <img
                          src={bannerUrl(post.id, post.data.banner)}
                          alt={post.data.title}
                          class="w-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                    )}

                    <div class="p-6">
                      <div class="flex items-start justify-between gap-2 mb-3">
                        <h3 class="text-xl font-semibold font-poppins">
                          <a
                            href={postUrl}
                            class="hover:text-[var(--accent)] transition-colors"
                          >
                            {post.data.title}
                          </a>
                        </h3>
                        {isMemo && (
                          <span class="text-xs px-2 py-1 bg-[var(--surface)] rounded-full text-[var(--muted)] shrink-0">
                            memo
                          </span>
                        )}
                      </div>

                      {post.data.description &&
                        post.data.description.trim() && (
                          <p class="text-[var(--muted)] mb-3">
                            {post.data.description}
                          </p>
                        )}

                      <div class="flex items-center text-sm text-[var(--muted)]">
                        <time datetime={post.data.date.toISOString()}>
                          {formatDate(post.data.date)}
                        </time>
                        <span class="mx-2">·</span>
                        <span>{formatReadingTime(readingTime)}</span>
                        {post.data.tags && post.data.tags.trim() && (
                          <>
                            <span class="mx-2">·</span>
                            <span>{post.data.tags.split(",")[0].trim()}</span>
                          </>
                        )}
                      </div>
                    </div>
                  </article>
                );
              })}
            </div>
          </section>
        ))
      }
    </div>
  </div>
</Layout>

<script>
  // Client-side filtering
  const filterButtons = document.querySelectorAll(".filter-btn");
  const postCards = document.querySelectorAll(".post-card");

  // Function to apply filter
  function applyFilter(filter: string | null) {
    // Update active button
    filterButtons.forEach((btn) => {
      if (btn.getAttribute("data-filter") === filter) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });

    // Filter posts
    postCards.forEach((card) => {
      const htmlCard = card as HTMLElement;
      if (!filter || filter === "all") {
        htmlCard.style.display = "block";
      } else {
        const postType = card.getAttribute("data-type");
        htmlCard.style.display = postType === filter ? "block" : "none";
      }
    });

    // Hide year sections where all posts are filtered out
    const yearSections = document.querySelectorAll(".year-section");
    yearSections.forEach((section) => {
      const visiblePosts = section.querySelectorAll(
        '.post-card:not([style*="display: none"])',
      );
      (section as HTMLElement).style.display =
        visiblePosts.length > 0 ? "block" : "none";
    });

    // Update URL
    const url = new URL(window.location.href);
    if (!filter || filter === "all") {
      url.searchParams.delete("filter");
    } else {
      url.searchParams.set("filter", filter);
    }
    window.history.pushState({}, "", url.toString());
  }

  // Apply filter from URL on page load
  const urlParams = new URLSearchParams(window.location.search);
  const initialFilter = urlParams.get("filter") || "all";
  applyFilter(initialFilter);

  // Handle filter button clicks
  filterButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const filter = button.getAttribute("data-filter");
      applyFilter(filter);
    });
  });
</script>
